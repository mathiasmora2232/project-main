<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Curricular - EduConnect</title>
    <link rel="icon" href="img/logojpg-removebg-preview.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/Global.css?v=2">
    <link rel="stylesheet" href="css/malla.css?v=2">
</head>
<body>
    <header>
        <nav>
            <a href="Homepage.html" class="logo">EduConnect</a>
            <ul class="nav-links">
                <li><a href="Homepage.html">Inicio</a></li>
                <li><a href="Materias.html">Materias</a></li>
                <li><a href="Malla.html" class="active">Malla Curricular</a></li>
                <li><a href="Calendario.html">Calendario</a></li>
                <li><a href="Cuenta.html">Mi Cuenta</a></li>
                <li id="adminLink" style="display:none;"><a href="admin/dashboard-admin.html">Panel Admin</a></li>
            </ul>
            <div class="nav-right">
                <button id="userMenuBtn" class="user-btn"><span id="userName">Usuario</span></button>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="Cuenta.html">Mi Perfil</a>
                    <button data-action="logout">Cerrar Sesion</button>
                </div>
            </div>
            <button class="burger-menu" id="burgerMenu" aria-label="Menu">&#9776;</button>
        </nav>
    </header>

    <main class="malla-container">
        <div class="page-header">
            <h1>Malla Curricular</h1>
            <p class="page-subtitle">Todas las materias disponibles agrupadas por semestre</p>
        </div>

        <div class="malla-grid" id="mallaGrid">
            <div class="loading-spinner">Cargando malla curricular...</div>
        </div>

        <div class="info-section" id="infoSection" style="display:none;">
            <div class="info-card">
                <h3>Resumen de la Malla</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalSemestres">0</div>
                        <div class="stat-label">Semestres</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalMaterias">0</div>
                        <div class="stat-label">Materias</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCreditos">0</div>
                        <div class="stat-label">Creditos Total</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js?v=2"></script>
    <script src="js/app.js?v=2"></script>
    <script src="js/adminlink.js?v=2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const materias = await getTodasMaterias();
                const grid = document.getElementById('mallaGrid');

                if (!materias.length) {
                    grid.innerHTML = '<p class="empty-state">No hay materias registradas.</p>';
                    return;
                }

                // Group by semester
                const semestres = {};
                materias.forEach(m => {
                    const sem = m.semestre || 1;
                    if (!semestres[sem]) semestres[sem] = [];
                    semestres[sem].push(m);
                });

                const semKeys = Object.keys(semestres).sort((a,b) => a - b);
                let totalCreditos = 0;

                grid.innerHTML = semKeys.map(sem => {
                    const mats = semestres[sem];
                    const semCreditos = mats.reduce((s, m) => s + (m.creditos || 0), 0);
                    totalCreditos += semCreditos;

                    return `
                    <div class="semestre-card">
                        <div class="semestre-header">
                            <h2>Semestre ${sem}</h2>
                            <div class="semestre-badge">${mats.length} Materias | ${semCreditos} Creditos</div>
                        </div>
                        <div class="materias-list">
                            ${mats.map(m => `
                                <div class="materia-item">
                                    <div class="materia-item-top">
                                        <div class="materia-name">${m.nombre}</div>
                                        <span class="materia-code-badge">${m.codigo || ''}</span>
                                    </div>
                                    <div class="materia-item-bottom">
                                        <span class="profesor-name">${m.profesor_nombre || 'Sin asignar'}</span>
                                        <span class="creditos-badge">${m.creditos || 0} cred.</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }).join('');

                // Update info section
                document.getElementById('totalSemestres').textContent = semKeys.length;
                document.getElementById('totalMaterias').textContent = materias.length;
                document.getElementById('totalCreditos').textContent = totalCreditos;
                document.getElementById('infoSection').style.display = 'block';

            } catch (error) {
                document.getElementById('mallaGrid').innerHTML = '<p class="error-state">Error al cargar la malla curricular.</p>';
            }
        });
    </script>
</body>
</html>
